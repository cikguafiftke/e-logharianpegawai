<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod USTP PPD Alor Gajah</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .header-bg { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; border-radius: 0 0 20px 20px; margin-bottom: 20px; }
        .btn-primary { background-color: #1e3c72; border: none; }
        .login-container { max-width: 400px; margin: 100px auto; }
        #loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; }
        .table-responsive { font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="loading" class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>

    <div id="login-page" class="container login-container">
        <div class="card p-4">
            <h4 class="text-center mb-4">Log Masuk USTP</h4>
            <div class="mb-3">
                <label>ID Pengguna</label>
                <input type="text" id="login-id" class="form-control" placeholder="Masukkan ID">
            </div>
            <div class="mb-3">
                <label>Kata Laluan</label>
                <input type="password" id="login-pass" class="form-control" placeholder="Masukkan Kata Laluan">
            </div>
            <button onclick="handleLogin()" class="btn btn-primary w-100">Masuk Sistem</button>
            <p id="login-error" class="text-danger mt-2 text-center" style="display:none;">ID atau Kata Laluan Salah!</p>
        </div>
    </div>

    <div id="dashboard-page" style="display: none;">
        
        <div class="header-bg text-center">
            <h2><i class="fas fa-calendar-check me-2"></i>Rekod Aktiviti Harian USTP</h2>
            <p>PPD Alor Gajah | Dokumentasi Profesional</p>
            <button onclick="logout()" class="btn btn-sm btn-danger mt-2"><i class="fas fa-sign-out-alt"></i> Log Keluar</button>
        </div>

        <div class="container mb-5">
            <div class="card p-4 mb-4">
                <h5 class="mb-3 text-primary"><i class="fas fa-edit"></i> Masukkan / Kemaskini Data</h5>
                <input type="hidden" id="data-id"> <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Tarikh</label>
                        <input type="date" id="input-tarikh" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Masa</label>
                        <input type="time" id="input-masa" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Jenis Aktiviti</label>
                        <select id="input-aktiviti" class="form-select">
                            <option value="Bimbingan">Bimbingan</option>
                            <option value="Mesyuarat">Mesyuarat</option>
                            <option value="Bengkel/Kursus">Bengkel/Kursus</option>
                            <option value="Aduan/Siasatan">Aduan/Siasatan</option>
                            <option value="Pejabat">Kerja Pejabat</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Jenis Bimbingan</label>
                        <select id="input-bimbingan" class="form-select">
                            <option value="-">- Tiada -</option>
                            <option value="Pedagogi">Pedagogi</option>
                            <option value="ICT">ICT / Digital</option>
                            <option value="Pengurusan">Pengurusan</option>
                            <option value="Kaunseling">Kaunseling</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Lokasi (Manual)</label>
                        <input type="text" id="input-lokasi" class="form-control" placeholder="Cth: SK Alor Gajah 1">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Bil. Guru</label>
                        <input type="number" id="input-bil-guru" class="form-control" value="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Catatan</label>
                        <input type="text" id="input-catatan" class="form-control" placeholder="Ringkasan aktiviti...">
                    </div>
                    
                    <div class="col-md-12">
                        <label class="form-label">Isu / Tindakan Susulan</label>
                        <textarea id="input-isu" class="form-control" rows="2" placeholder="Isu yang timbul atau tindakan yang perlu diambil..."></textarea>
                    </div>
                </div>

                <div class="mt-4 text-end">
                    <button onclick="resetForm()" class="btn btn-secondary me-2">Batal / Reset</button>
                    <button onclick="saveData()" class="btn btn-success"><i class="fas fa-save"></i> Simpan Rekod</button>
                </div>
            </div>

            <div class="card p-3 mb-3 bg-light">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label>Pilih Tahun</label>
                        <select id="filter-tahun" class="form-select" onchange="fetchData()">
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Pilih Bulan</label>
                        <select id="filter-bulan" class="form-select" onchange="fetchData()">
                            <option value="">Semua Bulan</option>
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Mac</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Jun</option>
                            <option value="7">Julai</option>
                            <option value="8">Ogos</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Disember</option>
                        </select>
                    </div>
                    <div class="col-md-6 text-end">
                        <button onclick="exportExcel()" class="btn btn-success btn-sm"><i class="fas fa-file-excel"></i> Export Excel</button>
                        <button onclick="exportPDF()" class="btn btn-danger btn-sm"><i class="fas fa-file-pdf"></i> Export PDF</button>
                    </div>
                </div>
            </div>

            <div class="card p-4">
                <h5 class="mb-3">Senarai Aktiviti</h5>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered" id="dataTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Tarikh</th>
                                <th>Masa</th>
                                <th>Aktiviti</th>
                                <th>Lokasi</th>
                                <th>Bil. Guru</th>
                                <th>Catatan</th>
                                <th>Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const PROJECT_URL = "https://xwpgsvhtscqmgnbpuhax.supabase.co";
        // Nota: Key ini diambil dari input anda. 
        const PUBLIC_KEY = "sb_publishable_SFuymUfXChIua588-X1XFA_wXkyIfOS"; 
        
        const supabase = window.supabase.createClient(PROJECT_URL, PUBLIC_KEY);

        // --- AUTH ---
        function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pass = document.getElementById('login-pass').value;

            if(id === 'afyf89' && pass === 'mfc-j415W') {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('dashboard-page').style.display = 'block';
                fetchData(); // Tarik data bila berjaya login
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function logout() {
            location.reload();
        }

        // --- CRUD SUPABASE ---
        
        // 1. READ (Baca Data)
        async function fetchData() {
            showLoading(true);
            const tahun = document.getElementById('filter-tahun').value;
            const bulan = document.getElementById('filter-bulan').value;

            let query = supabase
                .from('rekod_aktiviti')
                .select('*')
                .eq('tahun', tahun)
                .order('tarikh', { ascending: false })
                .order('masa', { ascending: false });

            if(bulan) {
                query = query.eq('bulan', bulan);
            }

            const { data, error } = await query;

            if (error) {
                alert('Ralat mengambil data: ' + error.message);
            } else {
                renderTable(data);
            }
            showLoading(false);
        }

        // 2. CREATE / UPDATE (Simpan Data)
        async function saveData() {
            const id = document.getElementById('data-id').value;
            const tarikh = document.getElementById('input-tarikh').value;
            const masa = document.getElementById('input-masa').value;
            const aktiviti = document.getElementById('input-aktiviti').value;
            const bimbingan = document.getElementById('input-bimbingan').value;
            const lokasi = document.getElementById('input-lokasi').value;
            const bilGuru = document.getElementById('input-bil-guru').value;
            const catatan = document.getElementById('input-catatan').value;
            const isu = document.getElementById('input-isu').value;

            if(!tarikh || !aktiviti) {
                alert("Sila isi Tarikh dan Jenis Aktiviti!");
                return;
            }

            // Kira Tahun dan Bulan dari tarikh untuk tujuan filter
            const dateObj = new Date(tarikh);
            const thn = dateObj.getFullYear();
            const bln = dateObj.getMonth() + 1; // JS bulan mula 0

            const payload = {
                tarikh: tarikh,
                masa: masa,
                jenis_aktiviti: aktiviti,
                jenis_bimbingan: bimbingan,
                lokasi: lokasi,
                bil_guru: bilGuru,
                catatan: catatan,
                isu: isu,
                tahun: thn,
                bulan: bln
            };

            showLoading(true);
            let error;

            if(id) {
                // Update
                const res = await supabase.from('rekod_aktiviti').update(payload).eq('id', id);
                error = res.error;
            } else {
                // Insert Baru
                const res = await supabase.from('rekod_aktiviti').insert([payload]);
                error = res.error;
            }

            showLoading(false);
            if(error) {
                alert("Gagal simpan: " + error.message);
            } else {
                alert("Berjaya disimpan!");
                resetForm();
                fetchData();
            }
        }

        // 3. DELETE (Padam)
        async function deleteData(id) {
            if(confirm("Adakah anda pasti mahu memadam rekod ini?")) {
                showLoading(true);
                const { error } = await supabase.from('rekod_aktiviti').delete().eq('id', id);
                showLoading(false);
                
                if(error) alert("Gagal padam: " + error.message);
                else fetchData();
            }
        }

        // --- FUNGSI UI HELPERS ---

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(row.tarikh)}</td>
                    <td>${row.masa ? row.masa.slice(0,5) : '-'}</td>
                    <td>
                        <strong>${row.jenis_aktiviti}</strong><br>
                        <small class="text-muted">${row.jenis_bimbingan}</small>
                    </td>
                    <td>${row.lokasi}</td>
                    <td>${row.bil_guru}</td>
                    <td>
                        ${row.catatan}<br>
                        ${row.isu ? '<span class="badge bg-warning text-dark">Isu: '+row.isu+'</span>' : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info mb-1" onclick='prepareEdit(${JSON.stringify(row)})'><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-warning mb-1" onclick='prepareCopy(${JSON.stringify(row)})'><i class="fas fa-copy"></i></button>
                        <button class="btn btn-sm btn-danger mb-1" onclick="deleteData(${row.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function prepareEdit(row) {
            document.getElementById('data-id').value = row.id;
            fillForm(row);
            window.scrollTo(0,0);
        }

        function prepareCopy(row) {
            document.getElementById('data-id').value = ''; // Kosongkan ID supaya jadi rekod baru
            fillForm(row);
            alert("Data disalin ke borang. Sila ubah Tarikh/Masa dan tekan Simpan.");
            window.scrollTo(0,0);
        }

        function fillForm(row) {
            document.getElementById('input-tarikh').value = row.tarikh;
            document.getElementById('input-masa').value = row.masa;
            document.getElementById('input-aktiviti').value = row.jenis_aktiviti;
            document.getElementById('input-bimbingan').value = row.jenis_bimbingan;
            document.getElementById('input-lokasi').value = row.lokasi;
            document.getElementById('input-bil-guru').value = row.bil_guru;
            document.getElementById('input-catatan').value = row.catatan;
            document.getElementById('input-isu').value = row.isu || '';
        }

        function resetForm() {
            document.getElementById('data-id').value = '';
            document.getElementById('input-tarikh').value = '';
            document.getElementById('input-masa').value = '';
            document.getElementById('input-lokasi').value = '';
            document.getElementById('input-bil-guru').value = '0';
            document.getElementById('input-catatan').value = '';
            document.getElementById('input-isu').value = '';
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('ms-MY');
        }

        function showLoading(isLoading) {
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
        }

        // --- FUNGSI EKSPORT ---
        
        function exportExcel() {
            const table = document.getElementById("dataTable");
            // Buang column 'Tindakan' sebelum export sementara
            const originalHTML = table.innerHTML;
            
            // Clone table untuk manipulasi (remove last column)
            // Cara mudah: Guna library XLSX table_to_book terus tapi kita nak buang column last
            const wb = XLSX.utils.table_to_book(table, {sheet: "Rekod"});
            XLSX.writeFile(wb, "Rekod_Aktiviti_USTP.xlsx");
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text("Laporan Aktiviti USTP", 14, 15);
            doc.autoTable({ html: '#dataTable', startY: 20, columns: [0,1,2,3,4,5] }); // Columns 0-5 sahaja
            doc.save("Laporan_USTP.pdf");
        }

    </script>
</body>
</html>